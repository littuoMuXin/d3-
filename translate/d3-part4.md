# D3：数据驱动文档（4）

## 4.设计原理

Protovis 是一种用于数据可视化的声明式语言，D3 与我们之前在 Protovis[2,13] 上做的工作有着密切联系。尽管 D3 与 Protovis  的目标相同，但在它们实现的可视化类型以及实现的方法上都存在区别。为了说明 D3 的贡献，我们将从三个区分因素上来描述它的设计原理：隐式或显式转换，延迟或即时计算，对原生表现层的访问。虽然 Protovis 擅长对静态场景的可视化，但 D3 的**转换**使得动态可视化变得更容易实现。而通过采用运算符的**即时计算**及浏览器的**原生表现层**，D3 还提高了兼容性和可调式性。

在 D3 中，设计者指定了场景的转化（场景变化），以区别表现层（场景本身）。**它们都是数据驱动的，只是转换通过明确控制哪些元素被改变、增加或者移除等， 能够更好地支持动态可视化。这消除了冗余的计算，我们只用去获取需要更新的元素以及属性即可，而不再是整个视图**。

转换自然而然地被扩展到了动画过渡中，属性、样式的值在动画过程中会随时间平滑地发生插值变化。我们在 Protovis  中进行了过渡实验[13]，它影响了我们对 enter 和 exit （参见 §3.2 ）的设计，但它的高级属性描述使得任意的场景变换实现起来比较困难。这在 Protovis  如何修改内部状态以响应用户事件，允许对表现层做出局部改变上很明显。“奇妙的”局部上下文对于原始的交互模式来说很方便，但并不通用（例如，元素不能被修改，除非接收到用户事件）。此外，自动上下文是用户困惑的频繁来源，因为它暂时覆盖了系统的行为。

转换还有另外一个好处，那就是它们可以修改已有的文档，将操作与生成进行解耦。这使得混合架构成为可能，在这种架构中，可视化在服务端被创建，动态行为则被绑定到客户端。

### 4.2 即时计算

通过把属性函数的计算延迟到渲染阶段，Protovis 允许隐式的属性重计算。尽管很方便，但如果引用的捕获是通过闭包的变化（或者消失）得到的，这将会导致错误。例如，一个全局变量有可能无意中被同一个页面中的另一个图形覆盖，并且直到交互触发重绘时才能被探测到。 JavaScript 中的 var 关键词存在于函数作用域中，而不是在其它语言中很典型的块级作用域，对其的普遍误解加剧了该语言的弱点。为了收紧引用捕获的范围，D3 即时应用运算操作。例如，D3 的 attr 运算符会立即设置选取节点的属性并返回。

即时运算减少了内部控制流，将其转移到了用户代码中。相比而言，Protovis  则隐藏了控制流，只有当系统崩溃（延迟计算的另一种令人困惑的结果）时才会暴露出来。即时性也与标准的 JavaScript 组织结构，如函数和循环等更加兼容。Protovis  无法生成任意的层级视图，因为它的层级深度受限于在代码中声明的嵌套面板的数量，而 D3 无状态的计算允许转换被重构为可被 each 运算符递归调用的函数。

内部机制使得 Protovis  布局的实现更加复杂，因为开发者必须理解属性被计算的顺序，特性的意义以及内部调用。D3 简化的控制流允许布局从属性计算中分离出来。D3 布局（见 §3.4）仅仅是一些辅助类，这些类会创建和修改任意的数据结构，如和弦图[20]的描述，或者是力导向图中节点的位置。然后，用户将布局数据绑定到期望的属性和元素上即可。

### 4.3 原生表现层

Protovis 的一个关键贡献在于它在图形原语上的选择，称为标志。Protovis 选取这些标志以满足普通图表类型的需求，如 Line 用于线图，Wedge 用于饼图，等等。Protovis 比其它的图形库具有更强大的表现力，因为它可以将这些简单的图形以不同的方式进行组合。

Protovis 的标志是有意均匀化的，属性对于不同的标志类型具有相同的含义。这使得原型继承成为可能，派生标志可以重用现有标志的属性定义，从而减少冗余。它还简化了迭代的设计，无须破坏相关代码，即可改变标志类型。如文本标记等相关标志很容易在 Protovis  中使用锚进行指定。

放弃特定表现层，选取如 SVG 等的标准，就是放弃了这些优点。例如，继承并不适用于 SVG 的异构图形（如，cx 是圆的属性，x 是矩形的属性）。另一方面，原生表现层支持使用 CSS 共享简单的属性定义，在前面讨论的包括互操作性、文档以及表现力上都具有优势。

定制的好处可以通过简单的辅助类得以体现，省去封装的成本。D3 的 arc 类可以方便我们使用 SVG 的 path 元素以及椭圆的弧形路径片段（见图7）等实现饼图。其输出与 Protovis 的 Wedge 相同，除了原生元素提高了工具的兼容性以及可调式性以外。然而，我们注意到，这种解耦确实会导致标记效率的略微下降。

最后，原生表现层的一个微妙但重要的优点在于选集可以在任何时候从文档中检索得到。为了修改 Protovis  的可视化，需要去修改底层数据或者是属性定义，然后再重绘。这需要在不影响全局的情况下记录下（如 var）场景中受影响的标记，如鼠标光标下的标记。相比较而言，D3 通过很多方式（如 tag 名称，class 属性以及关联数据）使用选择器来识别文档元素可以使得局部修改变得没有影响。由于选集是瞬态的，相比于单继承，它们也会因为复用获取更大的灵活性。
